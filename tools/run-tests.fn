(def *assertions-executed* 0)

;; TODO: Cache compiled tests, not just expressions.
(defn read-cached (filename)
  (deserialize-from-cache-file!
   (string-append filename ".exprc")
   (file-timestamp filename)
   (lambda () (read-all (file->string filename)))))

(defn run-test-file (filename)
  (dolist (item (read-cached filename))
    (eval `(assert ,item))
    (inc! *assertions-executed*)
    (writeout "."))
  (println))

(defn run-all-tests (filenames)
  (dolist (filename filenames)
    (writeout filename)
    (writeout ": ")
    (run-test-file filename))

  (println *assertions-executed* " assertions executed, 0 failures.")
  (println "Well done!"))

(when (empty? *args*)
  (error "You need to specify at least one file."))

(run-all-tests *args*)