
(

(eql '(let ((x 4)
            (y 8))
       (+ x y))
     (map-letdefinitions (lambda (x) (+ 3 x))
			 '(let ((x 1)
				(y 5))
			   (+ x y))))

(eql '(+ 9 y)
     (replace-var '(+ x y) 'x 9))

; Don't replace beyond a let that redefines x
(eql '(+ 42 (let ((x 34)) x))
     (replace-var '(+ x (let ((x 34)) x)) 'x 42))

; Dispatcher
;; ((dispatcher
;;   ('foo () true)) 'foo)

;; Variable environments
(->true
 (def %e empty-env)
 (def %xyz-env (env-with-vars empty-env 'x 'y 'z)))

(not (%e 'defines-immediately? 'x))
(%xyz-env 'defines-immediately? 'x)
(%xyz-env 'defines-immediately? 'z)
(not (%xyz-env 'defines-immediately? 'notthere))

(eq 0 (%e 'immediate-size))
(eq 3 (%xyz-env 'immediate-size))

; x shadows the old x.
(eq 5 ((env-with-vars %xyz-env 'a 'x) 'immediate-size))

(eql '(load-arg 1) (env-generate-read %xyz-env 'x))
(eql '(load-arg 2) (env-generate-read %xyz-env 'y))
(eql '(load-arg 3) (env-generate-read %xyz-env 'z))

)
